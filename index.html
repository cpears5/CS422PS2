<!--
CandyCrush
Your Name:
Collaborators:
-->
<!DOCTYPE html>
<html>
<!--
/* Copyright (c) 2017 MIT 6.813/6.831 course staff, all rights reserved.
 * Redistribution of original or derived work requires permission of course staff.
 */
-->

<head>
  <meta charset="utf-8">
  <title>CandyCrush</title>

  <!-- Load style sheets -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.css">

  <link rel="stylesheet" href="mainLayout.css">
  <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css">
  <!-- Use mobile-aware viewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Load any supplemental Javascript libraries here -->
  <script src="jquery.js"></script>
  <script src="seedrandom.js"></script>
  <script src="candy.js"></script>
  <script src="board.js"></script>
  <script src="rules.js"></script>

  <script>

    // By default, the first board loaded by your page will be the same 
    // each time you load (which is accomplished by "seeding" the random
    // number generator. This makes testing (and grading!) easier!
    Math.seedrandom(0);

    // A short jQuery extension to read query parameters from the URL.
    $.extend({
      getUrlVars: function () {
        var vars = [], pair;
        var pairs = window.location.search.substr(1).split('&');
        for (var i = 0; i < pairs.length; i++) {
          pair = pairs[i].split('=');
          vars.push(pair[0]);
          vars[pair[0]] = pair[1] &&
            decodeURIComponent(pair[1].replace(/\+/g, ' '));
        }
        return vars;
      },
      getUrlVar: function (name) {
        return $.getUrlVars()[name];
      }
    });

    // constants
    const DEFAULT_BOARD_SIZE = 8;

    // data model at global scope for easier debugging
    var board;
    var rules;

    // initialize board
    if ($.getUrlVar('size') && $.getUrlVar('size') >= 3) {
      board = new Board($.getUrlVar('size'));
    } else {
      board = new Board(DEFAULT_BOARD_SIZE);
    }

    // load a rule
    rules = new Rules(board);

    function numToAlpha(num) {
      if (num == 0) return 'a';
      else if (num == 1) return 'b';
      else if (num == 2) return 'c';
      else if (num == 3) return 'd';
      else if (num == 4) return 'e';
      else if (num == 5) return 'f';
      else if (num == 6) return 'g';
      else if (num == 7) return 'h';
      else if (num == 8) return 'i';
      else if (num == 9) return 'j';
      else if (num == 10) return 'k';
      else if (num == 11) return 'l';
      else if (num == 12) return 'm';
      else if (num == 13) return 'n';
      else if (num == 14) return 'o';
      else if (num == 15) return 'p';
      else if (num == 16) return 'q';
      else if (num == 17) return 'r';
      else if (num == 18) return 's';
      else if (num == 19) return 't';
      else if (num == 20) return 'u';
      else if (num == 21) return 'v';
      else if (num == 22) return 'w';
      else if (num == 23) return 'x';
      else if (num == 24) return 'y';
      else if (num == 25) return 'z';
    }
    function alphaToNum(alpha) {
      if (alpha == 'a') return 0;
      else if (alpha == 'b') return 1;
      else if (alpha == 'c') return 2;
      else if (alpha == 'd') return 3;
      else if (alpha == 'e') return 4;
      else if (alpha == 'f') return 5;
      else if (alpha == 'g') return 6;
      else if (alpha == 'h') return 7;
      else if (alpha == 'i') return 8;
      else if (alpha == 'j') return 9;
      else if (alpha == 'k') return 10;
      else if (alpha == 'l') return 11;
      else if (alpha == 'm') return 12;
      else if (alpha == 'n') return 13;
      else if (alpha == 'o') return 14;
      else if (alpha == 'p') return 15;
      else if (alpha == 'q') return 16;
      else if (alpha == 'r') return 17;
      else if (alpha == 's') return 18;
      else if (alpha == 't') return 19;
      else if (alpha == 'u') return 20;
      else if (alpha == 'v') return 21;
      else if (alpha == 'w') return 22;
      else if (alpha == 'x') return 23;
      else if (alpha == 'y') return 24;
      else if (alpha == 'z') return 25;
    }
    // Final initialization entry point: the Javascript code inside this block
    // runs at the end of start-up when the page has finished loading.
    $(document).ready(function () {
      // Your code here.
    });


    /* Event Handlers */
    // access the candy object with info.candy

    // add a candy to the board
    $(board).on('add', function (e, info) {

      const gameContainer = document.getElementById('gameContainer');
      var newBlock;
      if (document.getElementsByClassName(info.candy.row + "" + info.candy.col).length > 0) {
        newBlock = document.getElementsByClassName(info.candy.row + "" + info.candy.col)[0];
      } else {
        newBlock = document.createElement('td');
        newBlock.classList.add('block');
        newBlock.classList.add(info.candy.row + "" + info.candy.col);
        const blockCoord = document.createElement('div');
        blockCoord.textContent = numToAlpha(info.candy.row) + "" + info.candy.col;
        newBlock.appendChild(blockCoord);
        gameContainer.appendChild(newBlock);

      }

      newBlock.style.backgroundColor = info.candy.color;

      // Your code here.
    });

    // move a candy on the board
    $(board).on('move', function (e, info) {
      var candy = info.candy;
      var block = (document.getElementsByClassName(candy.row + "" + candy.col))[0];
      block.style.backgroundColor = candy.color;

      // Your code here.
    });

    // remove a candy from the board
    $(board).on('remove', function (e, info) {
      var candy = info.candy;
      var block = (document.getElementsByClassName(candy.row + "" + candy.col))[0];
      block.style.backgroundColor = 'lightgray';
    });

    // move a candy on the board
    $(board).on('scoreUpdate', function (e, info) {
      // Your code here. To be implemented in pset 2.
    });

    // Button Events
    $(document).on('click', '', function (evt) {

      // Your code here.
    });

    // keyboard events arrive here
    $(document).on('keydown', function (evt) {
      // Your code here.
    });
    function newGame() {
      // initialize board
      if (board === null)
        board = new Board(8);
      if (rules === null)
        rules = new Rules(board);
      board.clear();
      rules.prepareNewGame();
    }
    function arrowClicked(dir) {
      var candyLoc = document.getElementById('candyInput').value;
      if (candyLoc !== '') {
        var fromCandy = board.getCandyAt(alphaToNum(candyLoc.at(0)), Number(candyLoc.at(1)));
        var valid = rules.isMoveTypeValid(fromCandy, dir);
        if (valid) {
          var toCandy = board.getCandyInDirection(fromCandy, dir);
          board.flipCandies(fromCandy, toCandy);
        }
      }
      var arrows = document.getElementsByClassName('arrow');
      for (var i = 0; i < 4; i++) {
        arrows[i].setAttribute('disabled', '');
        arrows[i].style.backgroundColor = 'lightgray';
      }
      document.getElementById('candyInput').value = ''
      document.getElementById('candyInput').focus();
      if (rules.getCandyCrushes().length > 0)
        document.getElementById('crushButton').removeAttribute('disabled');
      else
        document.getElementById('crushButton').setAttribute('disabled', '');
    }

    function check() {

      var inputVal = document.getElementById('candyInput').value;
      var arrows = document.getElementsByClassName('arrow');
      if (inputVal == '' || inputVal.length > 2 || !isNaN(inputVal.at(0)) || isNaN(inputVal.at(1)))
        for (var i = 0; i < 4; i++) {
          arrows[i].setAttribute('disabled', '');
          arrows[i].style.backgroundColor = 'lightgray';
        }
      else {
        var fromCandy = board.getCandyAt(alphaToNum(inputVal.at(0)), Number(inputVal.at(1)));
        if (fromCandy !== undefined) {
          if (rules.isMoveTypeValid(fromCandy, 'up')) {
            arrows[0].removeAttribute('disabled');
            arrows[0].style.backgroundColor = 'lightblue';
          }
          if (rules.isMoveTypeValid(fromCandy, 'left')) {
            arrows[1].removeAttribute('disabled');
            arrows[1].style.backgroundColor = 'lightblue';
          }
          if (rules.isMoveTypeValid(fromCandy, 'right')) {
            arrows[2].removeAttribute('disabled');
            arrows[2].style.backgroundColor = 'lightblue';
          }
          if (rules.isMoveTypeValid(fromCandy, 'down')) {
            arrows[3].removeAttribute('disabled');
            arrows[3].style.backgroundColor = 'lightblue';
          }
        }
      }
    }

    function crush() {
      document.getElementById('crushButton').setAttribute('disabled', '');
      rules.removeCrushes(rules.getCandyCrushes());
      setTimeout(function () {
        rules.moveCandiesDown();
        var arrows = document.getElementsByClassName('arrow');
        for (var i = 0; i < 4; i++) {
          arrows[i].setAttribute('disabled', '');
          arrows[i].style.backgroundColor = 'lightgray';
        }
        document.getElementById('candyInput').focus();
        if (rules.getCandyCrushes().length > 0)
          document.getElementById('crushButton').removeAttribute('disabled');
        else
          document.getElementById('crushButton').setAttribute('disabled', '');
      }, 500);
      

    }



  </script>


</head>

<body>

  <div class="container">
    <!-- <div class="row"> -->
    <div class="col-md-3" id="firstColumn">
      <div>
        <!-- Column 1 Code Here -->
        <h1 style="color: red;">Candy Crush</h1>
        <button class="btn" id="newGameButton" onclick='newGame()'>New Game</button>
      </div>
    </div>

    <div class="col-md-6" id="mainColumn">
      <!-- Column 2 Code Here -->
      <table id="gameContainer">
      </table>
    </div>

    <div class="col-md-3" id="lastColumn">
      <!-- Column 3 Code Here -->
      <label for="move-input">Move: </label>
      <input id="candyInput" type="text" name="move-input" onkeyup="check()" />
      <div class="row">
        <div class="col-sm-12">
          <button style='font-size:24px' type="button" id="upArrow" onclick="arrowClicked('up')" class="arrow"
            disabled><i class="fas fa-arrow-up"></i></button>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-6">
          <button style='font-size:24px' type="button" id="leftArrow" onclick="arrowClicked('left')" class="arrow"
            disabled><i class="fas fa-arrow-left"></i></button>
        </div>
        <div class="col-sm-6">
          <button style='font-size:24px' type="button" id="rightArrow" onclick="arrowClicked('right')" class="arrow"
            disabled><i class="fas fa-arrow-right"></i></button>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12">
          <button style='font-size:24px' type="button" id="downArrow" onclick="arrowClicked('down')" class="arrow"
            disabled><i class="fas fa-arrow-down"></i></button>
        </div>
        <div class="row">
          <div class="col-sm-12">
            <button class="btn" id="crushButton" onclick="crush()" disabled>Crush Once</button>
          </div>
        </div>
      </div>
    </div>
  </div>

</body>

</html>